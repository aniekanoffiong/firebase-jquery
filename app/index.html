<html>

<head>
    <meta charset="utf-8">
    <title>Food Business</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
        crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        .img-preview {
            width: 50%;
            margin: 0 auto;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"
                        aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Hello Food</a>
                </div>

                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav navbar-right">
                        <li class="dropdown">
                            <a href="#" id="welcome-name" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Welcome <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a id="logout-btn" href="#"><span class="fa fa-sign-out"></span>&nbsp; Logout</a></li>
                            </ul>
                        </li>                        
                    </ul>
                </div>
                <!-- /.navbar-collapse -->
            </div>
            <!-- /.container-fluid -->
        </nav>

        <div class="container">
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#food-modal">Add Food</button>
            <hr />
            <div class="row food-listing">
                <h4 class="text-center text-info add-food">Add Food</h4>
            </div>
        </div>

        <div class="modal fade" id="food-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="vertical-alignment-helper">
                <div class="modal-dialog modal-sm vertical-align-center" role="document">
                    <div class="modal-content ">
                        <div class="modal-header no-border-bottom">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title text-center bold" id="myModalLabel">Add Food</h4>
                        </div>
                        <form id="food-create-form" enctype="multipart/form-data">

                            <div class="modal-body">
                                <div class="form-group">
                                    <label for="name" class="control-label">Food Name</label>
                                    <input type="text" id="name" name="name" value="" class="form-control form-control-line" placeholder="Food Name">
                                </div>
                                <div class="form-group">
                                    <label for="price" class="control-label">Price</label>
                                    <div class="input-group">
                                        <span class="input-group-addon">$</span>
                                        <input type="text" id="price" name="price" value="" class="form-control form-control-line" placeholder="Price">
                                        <span class="input-group-addon">.00</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="food-image" class="control-label">Image</label>
                                    <input type="file" id="food-image" name="cover_art" class="photo-upload-preview inline">
                                    <br />
                                    <div class="row photo-container hidden">
                                        <div class="preview-file bg-white">
                                            <img id="category-image" class="img-preview" height="30" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <div class="clear"></div>
                        <div class="modal-footer no-border-top text-center">
                            <button type="button" class="btn btn-danger inline" data-dismiss="modal">Cancel</button>
                            <button type="button" type="submit" class="btn btn-primary inline" id="create-food-btn">Add Food</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sign-in-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="vertical-alignment-helper">
            <div class="modal-dialog modal-sm vertical-align-center" role="document">
                <div class="modal-content ">
                    <div class="modal-header no-border-bottom">
                        <h4 class="modal-title text-center bold" id="myModalLabel">Sign In</h4>
                    </div>

                    <div class="modal-body">
                        <form id="food-create-form" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="name" class="control-label">Email</label>
                                <input type="email" id="email" name="email" value="" class="form-control form-control-line" placeholder="Email">
                            </div>
                            <div class="form-group">
                                <label for="name" class="control-label">Password</label>
                                <input type="password" id="password" name="password" value="" class="form-control form-control-line" placeholder="Password">
                            </div>
                        </form>
                        <div class="clear"></div>
                        <button type="button" type="submit" class="btn btn-primary center-block" id="sign-in-btn">Sign In</button>
                        <br />
                        <button type="button" type="submit" class="btn btn-primary btn-block" id="signInWithGoogle"><Span class="fa fa-facebook"></span>&nbsp; &nbsp; Sign In With Facebook</button>
                        <button type="button" type="submit" class="btn btn-danger btn-block" id="signInWithFacebook"><Span class="fa fa-google"></span>&nbsp; &nbsp; Sign In With Google</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
    <script src="image-preview.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.4.0/firebase.js"></script>
    <script>
        $(document).ready(function () {
            var config = {
                apiKey: "AIzaSyC5xFJoyqhna8Y_WDWGccpbQkD2YrQ-L9Q",
                authDomain: "gdg-uyo.firebaseapp.com",
                databaseURL: "https://gdg-uyo.firebaseio.com",
                projectId: "gdg-uyo",
                storageBucket: "gdg-uyo.appspot.com",
                messagingSenderId: "269788529032"
            };
            firebase.initializeApp(config);
            var database = firebase.database();
            var auth = firebase.auth();
            var storageRef = firebase.storage().ref();
            var foodCountRef = firebase.database().ref('food-list/top-food/');
            
            $('#create-food-btn').click(function () {
                var name = $('form#food-create-form input#name').val();
                var price = $('form#food-create-form input#price').val();
                var image = $('form#food-create-form input#food-image')[0].files[0];
                console.log(image);
                var id = database.ref('food-list/top-food/').push().key;
                var upload = handleFileSelect(id, name, price ,image);
            });

            $('body').on('click', '.remove-food', function () {
                console.log($(this).parents('div.food-item-listed').index());
                var parent = $(this).parents('div.food-item-listed');
                var id = $(this).prop('id');
                parent.remove();
                firebase.database().ref('food-list/top-food/' + id).remove();
            });

            $('button#signInWithGoogle').click(function () {
                var googleProvider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(googleProvider).then(function(result) {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    var token = result.credential.accessToken;
                    // The signed-in user info.
                    var user = result.user;
                    // ...
                }).catch(function(error) {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    // The email of the user's account used.
                    var email = error.email;
                    // The firebase.auth.AuthCredential type that was used.
                    var credential = error.credential;
                    // ...
                });
            });

            $('button#signInWithFacebook').click(function () {
                var facebookProvider = new firebase.auth.FacebookAuthProvider();
                auth.signInWithPopup(facebookProvider).then(function(result) {
                    // This gives you a Facebook Access Token. You can use it to access the Facebook API.
                    var token = result.credential.accessToken;
                    // The signed-in user info.
                    var user = result.user;
                    // ...
                }).catch(function(error) {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    // The email of the user's account used.
                    var email = error.email;
                    // The firebase.auth.AuthCredential type that was used.
                    var credential = error.credential;
                    // ...
                });
            });

            $('button#sign-in-btn').click(function () {
                var email = $('div#sign-in-modal input#email').val();
                var password = $('div#sign-in-modal input#password').val();
                auth.signInWithEmailAndPassword(email, password).catch(function(error) {
                    auth.createUserWithEmailAndPassword(email, password).catch(function(error) {
                        // Handle Errors here.
                        var errorCode = error.code;
                        var errorMessage = error.message;
                        // ...
                    });
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    // ...
                });
            });

            $('a#logout-btn').click(function () {
                firebase.auth().signOut().then(function() {
                    $('#bs-example-navbar-collapse-1 a#welcome-name').text('Welcome');
                    $('#bs-example-navbar-collapse-1 a#welcome-name').append('<span class="caret"></span>');
                }).catch(function(error) {
                    console.log("Logout error");
                });
            });

            auth.onAuthStateChanged(function(user) {
                if (! user) {
                    $('div#sign-in-modal').modal({
                        keyboard: false,
                        backdrop: 'static',
                        show: true,
                    })
                } else {
                    $('div#sign-in-modal').modal('hide');
                    $('#bs-example-navbar-collapse-1 a#welcome-name').text(user.email);
                    $('#bs-example-navbar-collapse-1 a#welcome-name').append('<span class="caret"></span>');
                    loadInitData();
                }
            });

            function loadInitData() {
                foodCountRef.once('value').then(function (snapshot) {
                    snapshot.forEach(function (childSnapshot) {
                        $('div.food-listing')
                            .append('<div class="col-sm-6 col-md-4 food-item-listed"  id="' + childSnapshotkey + '"><div class="thumbnail">' +
                            '<img src="' + childSnapshotval().food_image + '" alt="food-item"><div class="caption text-center">' +
                            '<h3>' + childSnapshotval().food_name + '</h3><p>' + childSnapshotval().food_prize + '</p>' +
                            '<button type="button" id="' + childSnapshot.key + '" class="btn btn-danger btn-sm center-block remove-food">Remove</button></div></div></div>');
                    });
                });
            }

            function writeUserData(userId, name, price, url) {
                database.ref('food-list/top-food/' + userId).set({
                    food_name: name,
                    food_prize: '$' + price,
                    food_image: url
                });
            }

            foodCountRef.on('child_added', function (snapshot) {
                console.log("child added");
                console.log(snapshot.key);
                if ($('div.food-listing h4.add-food')) {
                    $('div.food-listing h4.add-food').addClass('hidden');
                }
                $('div.food-listing')
                .append('<div class="col-sm-6 col-md-4 food-item-listed"  id="' + snapshot.key +'"><div class="thumbnail">' +
                        '<img src="' + snapshot.val().food_image + '" alt="food-item"><div class="caption text-center">' +
                            '<h3>' + snapshot.val().food_name + '</h3><p>' + snapshot.val().food_prize + '</p>' +
                            '<button type="button" id="' + snapshot.key + '" class="btn btn-danger btn-sm center-block remove-food">Remove</button></div></div></div>');
                $('div#food-modal').modal('hide');
            });

            // When Data Changes
            foodCountRef.on('child_changed', function (snapshot) {
                console.log("child changed");
                var element = $('div.food-listing food-item-listed#' + snapshot.key);
                if (element.find('img').prop('src') !== snapshot.val().food_image) {
                    element.find('img').prop('src', snapshot.val().food_image);
                }
                if (element.find('h3').html() !== snapshot.val().food_name) {
                    element.find('img').html(snapshot.val().food_name);
                }
                if (element.find('p').html() !== snapshot.val().food_prize) {
                    element.find('img').html(snapshot.val().food_prize);
                }
                if (element.find('button').prop('id') !== snapshot.key) {
                    element.find('button').prop('id', snapshot.key);
                }
            });

            // When Data is removed
            foodCountRef.on('child_removed', function (snapshot) {
                console.log("child removed");
                $('button#' + snapshot.key).parents('div.food-listing').remove();
                console.log('removed');
            });


            function handleFileSelect(id, name, price, file) {
                var metadata = { 'contentType': file.type }; 
                // Push to child path. 
                // [START oncomplete]
                storageRef.child('images/' + file.name).put(file,metadata)
                .then(function(snapshot) { 
                    console.log('Uploaded', snapshot.totalBytes, 'bytes.'); 
                    console.log(snapshot.metadata);
                    var url = snapshot.downloadURL;
                    console.log('File available at', url);
                    writeUserData(id, name, price, url);
                     // [END_EXCLUDE] 
                }).catch(function(error) { 
                    // [START onfailure] 
                    console.error('Upload failed:', error); 
                    // [END onfailure] 
                }); 
                // [END oncomplete] 
            }
            // writeUserData(1, "haha")
        });
    </script>
</body>

</html>